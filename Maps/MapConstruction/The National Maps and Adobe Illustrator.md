### The National Maps and Adobe Illustrator - Rich Miller, 4/24/2017

SUBJECT:  The gravel layer and the (apparent) failure of some maps to open in Adobe Illustrator (AI), even though they open in Adobe Reader, Acrobat, Mac Preview, and (most fortunately) in Inkscape (a free, open-source vector graphics editor).  I opened the recalcitrant files in Inkscape and there removed the big raster layers and saved subsets of the remaining vector layers as separate PDF files.  Everything opened quickly in AI except the gravel layer. I noticed that one file that did open in AI had a gravel layer, but it was small in extent.  That got me looking at the details of the coding for the gravel, and it turns out that it is very inefficient.  Not only does the gravel use a lot of data, but the particular organization of it is out-of-date, not using features that have become standard in drawing programs.  I will discuss this below.  Emboldened by these observations, I subsequently let AI take all the time it wanted to open one of the quadrangles that I had previously given up on.  After 10 minutes of CPU time, the file actually did open (this compared to a typical 5 seconds for files with no gravel).  But even once open, any manipulation involving the gravel ground on and on. Finally, by a modest amount of by-hand change, I was able to recode the gravel layers so that they look nearly identical to the originals, but use only about 1/5th as much data, and more importantly, open in just a few seconds, and once open, manipulate quickly.

BACKGROUND:  The newer maps in the USGS 7.5 minute series may be downloaded from https://store.usgs.gov/b2c_usgs/usgs/maplocator/(ctype=areaDetails&xcm=r3standardpitrex_prd&carea=%24ROOT&layout=6_1_61_48&uiarea=2)/.do as zipped PDF files approximiately 27 MB in size.  The files comprise a number of PDF layers, some of which contain raster images (satellite imagery, computed shading, etc) accounting for most of the file size), which are overlaid by scalable vector graphics (SVG) layers coding contours, geographical grids, waters, roads, and place and feature labels.

Most of the maps open quickly (a few seconds) in Adobe Illustrator (AI), which strips away the raster data, leaving just the SVG. The remaining data can be efficiently edited to add or remove objects, adjust text, change colors or textures, and the like, to produce derivative, special-purpose maps.  Much of the efficiency comes from AI’s hierarchical object list and the well designed interaction of the list with the graphical display.

Unfortunately, a few of the National Map files fail to open in AI (eg, Redcrest CA (from gda_7982168.zip) and Petrolia CA (from gda_7981896.zip)).  Typically, after 15 seconds or so, my 2.6 GHz, 8 GB Mac announced that AI has stopped responding.  Meanwhile Activity Monitor showed AI alive and taking almost all of the CPU time.  After a few minutes of this, I would give up and force quit AI.

I tested the integrity of the files in qpdf (a public domain, UNIX, command line PDF manipulation program), which (quickly) found no structural errors.

I then opened the Redcrest file in Inkscape.  After 15 seconds, a PDF Import settings dialog came up.  I left “import via Poppler” deselected, mesh precision rough (I was going to delete the images anyway), and left “Replace PDF fonts” and “Embed images” selected. About 2 minutes after pressing OK the map appeared in the display window.

STRIPPING TO THE MAP COMPONENTS:  Once a map is open in Inkscape, it can be readily stripped to its components. Note that Inkscape converts PDF layers to groups on loading. All these groups are put into a single Inkscape layer.  Make new layer above the original one (name it “Gravel”) and set it to invisible.  Immediately save your work as a .svg file.  With the arrow cursor, select the image (raster) groups and the frame text groups, one at a time and delete them (use ctrl-z to undo if you make a mistake).  When you have gotten rid of all the pics, you can more easily see what you’re doing. Delete all the vector graphics you don’t want:  in my case, contours, degree lines, geo marks, etc, leaving Water - Area, Water - Linear, Roads, Gravel, and all the various names.  Finally, if gravel is present, select its group and chose “Move to the layer above” from the Layers menu.  Make the gravel layer visible and the base layer invisible and locked.  Ungroup the gravel as necessary, and delete all but the part of the gravel you will need for the final map you are constructing.  Along the way, you can save your partial work as .svg files (which are native to Inkscape).  When you are done, make both layers visible and unlocked.  Save the 2-layer document as a .svg file.  Delete one of the layers, and save the other layer as a .pdf.  Close the document, open the saved 2-layer .svg, delete the other layer and save what remains as a .pdf.  At this point you have two .pdf files, one coding the gravel alone, and the other all the other vector data you kept.  The non-gravel file will open quickly in AI.  At least for the Redcrest and Petrolia files, the gravel layer alone also opened, after a few minutes, in AI.

THE STRUCTURE OF THE GRAVEL LAYER: Using the layers panel in AI it is easy to see what’s going on.  Basically, each separate gravel area is coded as a clipping mask (not drawn) that gives its outline super-imposed on a large collection of text objects, each of the form “.”.  The individual periods become the separate dots of gravel that show in the final drawing.  These text periods are placed, seemingly at random positions in a rectangle that contains the clipping outline.  Many, if not most of the periods end up lying outside the clipping region, and do not show in the final drawing.  Still, they use memory and take time to evaluate for inclusion.

But this is not all the complication.  As implemented, the collection of periods is not as dense in the drawing as was desired, rather than just making a larger set of randomly placed periods, the entire construction of the previous paragraph is repeated two more times.  Since the periods are placed randomly, they do not overlie, and so the array of gravel dots becomes 3 times as dense.

Finally, the designers wanted the outline of the gravel region to show as a dashed line.  To implement this, yet another group of objects is produced, each object in the group being a hard-coded 3-element path that draws a single dash of the outline.

ANOTHER WAY OF DOING THIS:  Current PDF drawing programs implement the notions of stroke and fill for any closed path, the former being a drawing specification for the outline of the enclosed region, and the latter one for the interior area.  By default, the stroke is drawn to overlie the fill at the edges.  Strokes and themes may be colored and PATTERNED independently.  In the present case, the stroke of the clipping mask outline can be set to draw as a dashed line (of whatever particular description you may want), and the fill can be drawn using a predefined texture pattern swatch.  AI comes with a built in set of patterns that can be associated with a fill just as easily as associating a color, and in fact, one of the built-in patterns is labeled “USGS 22 Gravel Beach”.  It looks like a set of randomly placed disks of two different sizes, representing individual stones.

So, the fix for me was to keep just one set of clipping paths, freed from their clipping role, treated just as closed paths.  I set their stroke attribute to a dashed line of the right width, dash-pattern, and color to match the original map, and set their fill pattern to USGS 22.  And threw away everything else.

Now, actually, USGS 22 as provided is not as dense a pattern as the original and was colored black, so I made a custom swatch pattern by overlaying two more copies of USGS 22, one rotated clockwise by 90 degrees and the other rotated counter clockwise by the same amount, colored it to match the original and used this new USGS 22 x 3.

The final result was a coding that looks even better than the original in that there are multiple dot sizes, consumes about a fifth the amount of data, and most importantly, opens and manipulates in a couple of seconds rather than many minutes.

A PRETTY FAST AD-HOC WAY TO COVERT THE ORIGINAL TO THE PROPOSED DRAWING SCHEME:  With the gravel isolated in its own layer, and any other layers locked and invisible, open the outside gravel group.  You will see a long, linear list of groups.  Starting from the last group in the list and working your way up, shift-select groups as long as additional selection highlights the outline of a new (distinct from any previously highlighted) gravel area in the drawing pane.  When you have finished thus selecting a minimal complete set of outlines, make them into a group of their own (the new gravel group), and drag that group outside of the original gravel group.  Select the original group and delete it.  That gets rid of most of the redundancy.  However, each group in the new group comprises a clipping path followed by a sequence of “.” text objects.  We want to get rid of all of these without losing any of the paths.  This is easily done in AI by opening the first of the subgroups and selecting just one of the “.” items.  Then go to the “Select” menu and choose the “Same” submenu and then the “Stroke & Fill” submenu item of that.  This will select all of the “.” objects  leaving all of the path objects unselected.  Hit delete.  You will be left with the new gravel group containing a linear list of paths.  Select the group and set its stroke to be a dashed line with the desired color (a gray brown).  Then set the stroke to be the USGS 22 x 3 pattern swatch you made previously.  Move the gravel group back into the main map layer, and you’re done.


A NOTE ON THE CODING OF WATER AREAS:  A final comment.  The water areas like rivers, oceans, and lakes, but not the linear water like streams, are also not encoded optimally, but that doesn’t cause an important problem like the gravel does.  The water areas are all just doubly coded, each represented by two identical, adjacent paths or compound paths, the higher one with stroke set to a blue color and its fill to none, and the lower with stroke set to none and the fill to a lighter blue.  Both these colors are darker than the desired final color, and the final color is gotten by setting the group opacity to 30%.  None of this elaboration is necessary.  Retain one object of each of the object pairs, then select the containing group and set its fill to the desired final light blue color and it stroke to the desired darker blue.  Don’t set any opacity masking.
